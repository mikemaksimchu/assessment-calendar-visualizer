<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>District-Wide Assessment Calendar & Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/save-svg-as-png/1.4.17/saveSvgAsPng.min.js"></script>
    <!-- ics.js for iCal generation -->
    <script src="https://cdn.jsdelivr.net/npm/ics@3.7.2/dist/ics.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .gantt-chart-container { width: 100%; overflow-x: auto; background-color: #ffffff; padding: 1rem 0; border-radius: 1rem; }
        
        .action-btn, .export-btn, .view-select {
            padding: 8px 16px; border: none; border-radius: 8px; color: white;
            font-weight: 500; cursor: pointer; transition: background-color 0.2s;
            white-space: nowrap;
        }
        .action-btn:hover, .export-btn:hover, .view-select:hover { opacity: 0.9; }
        .view-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #0072b8; /* Kent ISD Blue */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem;
        }

        /* color definitions for header buttons */
        #reconfigure-btn {
            background-color: #417E38; /* Kent ISD Dark Green ("Palm Green") */
        }
        #export-btn {
            background-color: #8CC63F; /* Kent ISD Light Green ("Android Green") */
        }

        #splash-modal, #setup-modal, #details-modal, #export-modal {
            background: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            height: 90vh;
            max-height: 800px;
        }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .date-input { border: 1px solid #cbd5e1; border-radius: 6px; padding: 4px 8px; }
        .hidden { display: none; }
        
        /* Details Modal Styles */
        #details-modal-content a { color: #60a5fa; text-decoration: underline; }
        #details-modal-content strong { color: #f59e0b; font-weight: 600; }

        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 4px;
            color: #0072b8;
        }
        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #334155;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 60; /* Higher than modal */
            bottom: 125%; /* Position above the icon */
            left: 50%;
            margin-left: -150px; /* Use half of the width to center */
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 400;
            font-size: 0.875rem; /* 14px */
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* Splash Page Link Styles */
        .splash-link {
            color: #0072b8;
            text-decoration: underline;
            font-weight: 500;
        }

        /* Export Modal Styles */
        .export-option-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0; /* slate-200 */
            background-color: #ffffff; /* white */
            text-align: left;
            font-weight: 500;
            color: #334155; /* slate-700 */
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .export-option-btn:hover {
            background-color: #f8fafc; /* slate-50 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .export-option-btn svg {
            color: #0072b8; /* Kent ISD Blue */
        }
        .export-option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f1f5f9; /* slate-100 */
        }
         .export-option-btn:disabled:hover {
            background-color: #f1f5f9; /* slate-100 */
            box-shadow: none;
        }

        /* Calendar View Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            border-left: 1px solid #e2e8f0;
            border-top: 1px solid #e2e8f0;
        }
        .calendar-day-header {
            font-size: 0.75rem;
            text-align: center;
            padding: 4px;
            background-color: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #475569;
        }
        .calendar-day {
            min-height: 120px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 4px;
            font-size: 0.75rem;
            background-color: #fff;
        }
        .calendar-day.other-month {
            background-color: #f8fafc;
            color: #94a3b8;
        }
        .calendar-day-num {
            font-weight: 500;
        }
        .calendar-event {
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 2px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        /* Year-at-a-Glance */
        .year-view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .year-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-left: 1px solid #e2e8f0;
            border-top: 1px solid #e2e8f0;
        }
        .year-day-header {
            font-size: 0.65rem;
            font-weight: 600;
            text-align: center;
            padding: 2px;
            background-color: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
        }
        .year-day-cell {
            font-size: 0.7rem;
            height: 28px;
            width: 100%;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 2px;
            position: relative;
        }
        .year-day-cell.other-month {
            background-color: #f8fafc;
            color: #cbd5e1;
        }
        .year-day-cell .day-num {
            color: #64748b;
        }
        .year-event-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            bottom: 3px;
            left: 3px;
        }
        .year-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }
        .year-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Print Styles */
        @media print {
            body {
                background-color: #ffffff;
                font-family: 'Inter', sans-serif;
            }
            #splash-modal, #setup-modal, #details-modal, #export-modal, #main-content header, #main-content footer {
                display: none !important;
            }
            #main-content {
                display: block !important;
                padding: 0;
                margin: 0;
            }
            main {
                padding: 0;
                margin: 0;
            }
            #visualization {
                overflow: visible;
                box-shadow: none;
                padding: 0;
            }
            .gantt-chart-container, #year-view, #month-view {
                display: none; /* Hide all views by default */
            }
            #print-container {
                display: block !important; /* Show only the print container */
            }

            /* Monthly Print */
            .month-view-print-page {
                page-break-after: always;
                padding-top: 1in;
                padding-left: 0.5in;
                padding-right: 0.5in;
                padding-bottom: 0.5in;
            }
            .month-view-print-page:last-child {
                page-break-after: avoid;
            }
            .month-view-print-page h2 {
                font-size: 24pt;
                font-weight: bold;
                text-align: center;
                margin-bottom: 16px;
            }
            .calendar-grid {
                border: 2px solid #333;
            }
            .calendar-day-header {
                font-size: 10pt;
                font-weight: bold;
                background-color: #eee;
                color: #000;
                border: 1px solid #666;
            }
            .calendar-day {
                min-height: 100px;
                border: 1px solid #666;
                padding: 4px;
                font-size: 9pt;
                vertical-align: top;
            }
            .calendar-day.other-month {
                background-color: #f9f9f9;
                color: #aaa;
            }
            .calendar-event {
                font-size: 8pt;
                padding: 2px 4px;
                border-radius: 4px;
                margin-top: 2px;
                color: white;
                border: 1px solid #333;
                -webkit-print-color-adjust: exact; /* Force color printing */
                color-adjust: exact;
            }

            /* Year-at-a-Glance Print */
            #year-view-print-container {
                width: 100%;
                page-break-inside: avoid;
            }
             .year-view-print-header {
                text-align: center;
                margin-bottom: 24px;
            }
            .year-view-print-header h1 {
                font-size: 28pt;
                font-weight: bold;
            }
            .year-view-print-header h2 {
                font-size: 16pt;
                color: #555;
            }
            .year-view-grid {
                grid-template-columns: repeat(3, 1fr) !important; /* 3 columns for landscape */
                gap: 1rem;
                padding: 0;
                box-shadow: none;
                background: none;
            }
            .year-month-container {
                page-break-inside: avoid;
            }
            .year-month-container h3 {
                font-size: 14pt;
                font-weight: 600;
                margin-bottom: 8px;
            }
            .year-month-grid {
                border: 1px solid #666;
            }
            .year-day-header {
                font-size: 7pt;
                padding: 2px;
                background-color: #eee;
                color: #000;
                border: 1px solid #999;
            }
            .year-day-cell {
                font-size: 7pt;
                height: 24px;
                border: 1px solid #999;
                padding: 2px;
            }
            .year-day-cell .day-num {
                color: #333;
            }
            .year-day-cell.other-month {
                background-color: #f9f9f9;
                color: #ccc;
            }
            .year-event-dot {
                width: 6px;
                height: 6px;
                bottom: 2px;
                left: 2px;
                border: 1px solid #000;
                 -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            #year-view-legend {
                page-break-before: always;
                padding-top: 1in;
            }
            .year-legend-item {
                font-size: 10pt;
                gap: 8px;
                page-break-inside: avoid;
            }
            .year-legend-dot {
                width: 12px;
                height: 12px;
                border: 1px solid #000;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Splash Page Modal -->
    <div id="splash-modal" class="fixed inset-0 z-40 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col modal-content">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-slate-700">Assessment Calendar Builder</h2>
            </div>
            <div class="p-8 overflow-y-auto flex-grow text-slate-600 leading-relaxed space-y-6">
                <div>
                    <h3 class="font-semibold text-lg text-slate-700 mb-2">A Vision for Balanced Assessment</h3>
                    <p class="text-sm">
                        “Kent ISD is committed to maintaining a balanced assessment system that supports both teaching and learning by integrating multiple measures of student understanding. This balance includes assessments for learning; those that guide instruction and provide ongoing feedback to students, and assessments of learning that verify mastery and inform reporting. The goal is to ensure that every assessment serves a clear instructional purpose, minimizes unnecessary testing, and reflects the diverse cultural and linguistic backgrounds of our students.
                    </p>
                    <p class="mt-2 text-sm">
                        When the assessment calendar is overlaid on the district’s school calendar, it provides a visual representation of when assessments occur throughout the year in relation to instructional cycles, breaks, and key community events. This alignment helps educators identify potential periods of over-assessment, plan for meaningful assessment opportunities to maximize feedback and impact, and coordinate instructional pacing to optimize student learning and well-being. Ultimately, the calendar serves as both a planning and communication tool; helping teachers, administrators, students, and families understand how assessment supports growth, guides instruction, and contributes to a cohesive learning experience across the district.”
                    </p>
                </div>

                <div>
                    <h3 class="font-semibold text-lg text-slate-700 mb-2">Moving Toward Balance</h3>
                    <p class="text-sm">
                        After building your calendar, it may become evident that the assessment landscape doesn't feel very "balanced." This is a common and valid realization. The first step to improving a system is visualizing it. If you'd like to learn more about creating a truly balanced system, we encourage you to explore resources like the Michigan Assessment Consortium's (MAC) <a href="https://www.michiganassessmentconsortium.org/abca-for-leas/" target="_blank" class="splash-link">ABCA for LEA program</a>.
                    </p>
                </div>

                <div>
                    <h3 class="font-semibold text-lg text-slate-700 mb-2">Considering Demographic Context</h3>
                    <p class="text-sm">
                        A calendar tells one story, but your student data tells another. Considering your district's demographic data can add critical context to your assessment schedule. For example, understanding college-going rates, religious observances, or the number of English Learners can help ensure your assessment windows are equitable and appropriate for all students.
                    </p>
                    <p class="text-sm mt-2">
                        We encourage you to use <a href="https://mischooldata.org/" target="_blank" class="splash-link">MI School Data</a> to explore this context:
                    </p>
                    <ul class="list-disc list-inside text-sm mt-2 space-y-1">
                        <li><a href="https://mischooldata.org/dashboard/" target="_blank" class="splash-link">District & School Dashboards:</a> View detailed enrollment breakdowns by race, gender, special education status, and more.</li>
                        <li><a href="https://mischooldata.org/english-learner-dashboard/" target="_blank" class="splash-link">English Learner Data:</a> See the number of EL students and their home languages.</li>
                        <li><a href="https://mischooldata.org/student-attendance/" target="_blank" class="splash-link">Attendance & Outcomes Data:</a> Contextualize academic outcomes with demographic and attendance data.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-lg text-slate-700 mb-2">About This Tool</h3>
                    <p class="text-sm">
                        This tool was developed by Mike Maksimchuk, EdD, Assessment Consultant for Kent ISD. If you have questions, feedback, or suggestions, please do not hesitate to reach out at <a href="mailto:mikemaksimchuk@kentisd.org" class="splash-link">mikemaksimchuk@kentisd.org</a> or 616-447-5667.
                    </p>
                </div>
                
                <div class="text-xs text-slate-500 pt-4 border-t border-slate-200">
                    <p class="font-semibold">Legal Disclaimer & License</p>
                    <p class="mt-1">
                        This work, developed by Kent ISD, is licensed under a <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" class="splash-link">Creative Commons Attribution-NonCommercial 4.0 International License</a>. You are free to share and adapt this work for non-commercial purposes, provided you give appropriate credit to Kent ISD.
                    </p>
                    <p class="mt-1">
                        This tool is provided "as is" without warranty of any kind. All data entered is processed locally in your browser and is not saved, stored, or transmitted to any server. Users are solely responsible for ensuring that any data entered, visualized, or shared complies with all applicable privacy laws, including the Family Educational Rights and Privacy Act (FERPA).
                    </p>
                </div>

            </div>
            <div class="p-6 bg-slate-50 border-t rounded-b-2xl">
                <button id="splash-proceed-btn" class="action-btn bg-[#8cc63f] w-full text-lg py-3">Ready to Start Building</button>
            </div>
        </div>
    </div>


    <!-- Setup Modal -->
    <div id="setup-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <div> <!-- Title and Subtitle -->
                    <h2 class="text-2xl font-bold text-slate-700">Create Your Assessment Calendar</h2>
                    <p class="text-slate-500">Select grades, assessments, and holidays to build your custom visualization.</p>
                </div>
                <div> <!-- Upload Button -->
                    <button id="upload-data-btn" class="action-btn bg-[#0072b8] whitespace-nowrap">Upload Config</button> <!-- Changed color -->
                    <input type="file" id="upload-data-input" class="hidden" accept=".json">
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <!-- Step 1: View Range -->
                 <div class="mb-8">
                     <h3 class="font-semibold text-lg mb-3 text-slate-600">1. Select View Range</h3>
                     <div class="flex items-center gap-4">
                         <input type="date" id="view-range-start" class="date-input" value="2025-08-01">
                         <span class="text-slate-500">to</span>
                         <input type="date" id="view-range-end" class="date-input" value="2026-06-30">
                     </div>
                 </div>
                <!-- Step 2: Grades -->
                <div class="mb-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">2. Select Grade Levels</h3>
                    <div id="grade-filters" class="grid grid-cols-4 sm:grid-cols-7 gap-3 text-sm"></div>
                </div>
                <!-- Step 3: Assessments -->
                <div class="mb-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">3. Select District & State Assessments</h3>
                    <div id="assessment-filters" class="space-y-4"></div>
                </div>
                 <!-- Step 4: Local Assessments -->
                <div class="mb-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">4. Add Local / Custom Assessments</h3>
                     <label class="flex items-center cursor-pointer mb-4">
                         <input type="checkbox" id="include-local-assessments" class="h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]">
                         <span class="ml-2">Include Local / Custom Assessments</span>
                     </label>
                    <div id="local-assessments-container" class="hidden">
                        <div class="flex flex-col md:flex-row gap-3 items-center">
                            <input type="text" id="other-assessment-name" placeholder="E.g., Unit 1 Math Test" class="date-input w-full md:w-1/2">
                            <input type="date" id="other-assessment-start" class="date-input w-full md:w-1/4">
                            <input type="date" id="other-assessment-end" class="date-input w-full md:w-1/4">
                            <button id="add-other-btn" class="action-btn bg-[#0072b8] whitespace-nowrap px-4 py-2 text-sm w-full md:w-auto">Add</button>
                        </div>
                        <div id="other-assessments-list" class="mt-3 text-sm text-slate-600 space-y-1"></div>
                    </div>
                </div>
                <!-- Step 5: Holidays -->
                <div>
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">5. Configure Holidays</h3>
                    <label class="flex items-center cursor-pointer mb-4">
                        <input type="checkbox" id="include-holidays" class="h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]">
                        <span class="ml-2">Include Religious Holidays</span>
                    </label>
                    <div id="holiday-filters-container" class="hidden">
                        <h4 class="font-medium mb-2 text-slate-500">Select Religions to Display:</h4>
                        <div id="holiday-filters" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                    </div>
                </div>
                <!-- Step 6: District Calendar -->
                <div class="mt-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">6. District Calendar Considerations</h3>
                    <p class="text-sm text-slate-500 mb-4">
                        As you build your calendar, remember to consider your district's main calendar. Think about the first and last days of school, marking periods, parent-teacher conferences, and major breaks (e.g., Winter Break, Spring Break) that may impact your assessment windows.
                    </p>
                    <label class="flex items-center cursor-pointer mb-4">
                         <input type="checkbox" id="include-district-events" class="h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]">
                         <span class="ml-2">Include District Calendar Events (e.g., Spring Break)</span>
                     </label>
                    <div id="district-events-container" class="hidden">
                        <div class="flex flex-col md:flex-row gap-3 items-center">
                            <input type="text" id="district-event-name" placeholder="E.g., Spring Break" class="date-input w-full md:w-1/2">
                            <input type="date" id="district-event-start" class="date-input w-full md:w-1/4">
                            <input type="date" id="district-event-end" class="date-input w-full md:w-1/4">
                            <button id="add-district-event-btn" class="action-btn bg-[#0072b8] whitespace-nowrap px-4 py-2 text-sm w-full md:w-auto">Add</button>
                        </div>
                        <div id="district-events-list" class="mt-3 text-sm text-slate-600 space-y-1"></div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t rounded-b-2xl">
                <button id="generate-calendar-btn" class="action-btn bg-[#8cc63f] w-full text-lg py-3">Generate Calendar</button>
            </div>
        </div>
    </div>
    
    <!-- Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div id="details-modal-content" class="bg-slate-800 text-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative leading-relaxed">
            <button id="details-modal-close" class="absolute top-4 right-4 text-slate-400 hover:text-white text-3xl leading-none">&times;</button>
            <div id="details-modal-body"></div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-700">Save / Export</h2>
                <button id="export-modal-close" class="text-slate-400 hover:text-slate-600 text-3xl leading-none">&times;</button>
            </div>
            <!-- Body -->
            <div class="p-6 space-y-4">
                
                <!-- Option 1: PDF -->
                <button id="export-pdf-btn" class="export-option-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                      <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                      <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zM1 7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1zm3 5a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1z"/>
                    </svg>
                    <div>
                        <span class="font-semibold">Print / Save as PDF</span>
                        <p class="text-sm text-slate-500 font-normal">Open print dialog for PDF or paper copies.</p>
                    </div>
                </button>

                <!-- Option 2: PNG -->
                <button id="export-png-btn" class="export-option-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
                      <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                      <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
                    </svg>
                    <div>
                        <span class="font-semibold">Save as PNG</span>
                        <p class="text-sm text-slate-500 font-normal">Download a PNG image (Gantt Chart view only).</p>
                    </div>
                </button>

                <!-- Option 3: Data File -->
                <button id="export-data-btn" class="export-option-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-floppy" viewBox="0 0 16 16">
                      <path d="M11 2h-6v3h6z"/>
                      <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h5a.5.5 0 0 0 0-1h-5a.5.5 0 0 0-.5.5M7.5 10a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/>
                    </svg>
                    <div>
                        <span class="font-semibold">Save Data File (.json)</span>
                        <p class="text-sm text-slate-500 font-normal">Save your settings. <strong class="text-amber-600">Do this to avoid losing work!</strong></p>
                    </div>
                </button>
                
                <!-- Option 4: iCal -->
                <button id="export-ical-btn" class="export-option-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-calendar-plus" viewBox="0 0 16 16">
                      <path d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7"/>
                      <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                    </svg>
                    <div>
                        <span class="font-semibold">Save as .iCal File</span>
                        <p class="text-sm text-slate-500 font-normal">Export all events to a calendar (e.g., Google, Outlook).</p>
                    </div>
                </button>

            </div>
        </div>
    </div>


    <!-- Main Content (Initially Hidden) -->
    <div id="main-content" class="container mx-auto p-4 md:p-8 hidden">
        <header class="flex flex-col items-center mb-8 pb-4 border-b border-slate-200">
            <!-- Top Part: Logo and Title -->
            <div class="flex flex-col sm:flex-row items-center gap-4 text-center sm:text-left">
                <img src="https://kentisd-cdn.fxbrt.com/downloads/about_kent_isd/kentisd-final-logos_primary-logo-gradient-tag.png" alt="Kent ISD Logo" class="h-14 md:h-16">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-700">District-Wide Assessment Calendar</h1>
                    <p id="calendar-subtitle" class="text-sm md:text-base text-slate-500">2025-2026 Academic Year</p>
                </div>
            </div>
            <!-- Bottom Part: Buttons -->
            <div id="reconfigure-btn-container" class="flex flex-wrap justify-center gap-3 mt-6">
                 <select id="view-switcher" class="view-select">
                    <option value="gantt">Gantt Chart View</option>
                    <option value="year">Year-at-a-Glance View</option>
                    <option value="month">Monthly View</option>
                </select>
                <button id="reconfigure-btn" class="action-btn">Re-configure</button>
                <button id="export-btn" class="export-btn">Save / Export</button>
            </div>
        </header>

        <main>
            <!-- NEW WARNING DIV -->
            <div id="visualization-warnings" class="mb-4"></div>
            
            <!-- Gantt Chart View -->
            <div id="gantt-view" class="gantt-chart-container shadow-lg"></div>

            <!-- Year-at-a-Glance View -->
            <div id="year-view" class="hidden">
                <div class="year-view-grid" id="year-view-grid"></div>
                <div class="mt-8 p-6 bg-white rounded-lg shadow">
                    <h3 class="font-semibold text-lg text-slate-700 mb-4">Legend</h3>
                    <div id="year-view-legend" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                </div>
            </div>

            <!-- Monthly View -->
            <div id="month-view" class="hidden space-y-8"></div>
            
            <!-- Container for printing -->
            <div id="print-container" class="hidden"></div>
        </main>
        <footer class="text-center mt-8 pt-4 border-t text-sm text-slate-500">
            <p>If you have questions about this tool or its output, please contact Mike Maksimchuk, Assessment Consultant at Kent ISD, at <a href="mailto:mikemaksimchuk@kentisd.org" class="text-[#0072b8] underline">mikemaksimchuk@kentisd.org</a> or 616-447-5667.</p>
        </footer>
    </div>
    
    <script>
        // --- DATA ---
        
        // Color Palette
        const categoryColors = {
            "State Mandated": "#DC2626", // Red-600
            "College Readiness": "#059669", // Emerald-600
            "Career Readiness": "#0284C7", // Sky-600
            "Benchmark": "#D97706", // Amber-600
            "English Learner": "#6D28D9", // Violet-700
            "Alternate": "#DB2777", // Pink-600
            "Local / Custom": "#57534E", // Stone-600
            "Religious Holiday": "#0F766E", // Teal-700
            "District Event": "#4B5563"  // Gray-600
        };

        const categorizedAssessments = {
            "State Mandated": [
                { id: 'mstep_ela_math', grade: ['3','4','5','6','7'], name: 'M-STEP (ELA, Math)', category: 'State Mandated', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'ELA, Math', duration: 'Varies, approx. 1-2.5 hours per subject', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/m-step', definition: 'Michigan Student Test of Educational Progress (M-STEP): A summative assessment for grades 3-7 (ELA/Math) and 5, 8, 11 (Sci/SS) that measures proficiency in state standards.' },
                { id: 'mstep_sci_ss', grade: ['5', '8', '11'], name: 'M-STEP (Science, SS)', category: 'State Mandated', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'Science, Social Studies', duration: 'Varies, approx. 1-1.5 hours per subject', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/m-step', definition: 'Michigan Student Test of Educational Progress (M-STEP): A summative assessment for grades 3-7 (ELA/Math) and 5, 8, 11 (Sci/SS) that measures proficiency in state standards.' },
            ],
            "College Readiness & Career": [
                { id: 'psat89_fall', grade: ['8'], name: 'PSAT 8/9 (Fall)', category: 'College Readiness', startDate: '2025-10-01', endDate: '2025-10-31', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://satsuite.collegeboard.org/psat-8-9', definition: 'Preliminary SAT (PSAT) 8/9: A test from the College Board suite that establishes a baseline for college readiness and practice for the SAT.' },
                { id: 'psat_nmsqt', grade: ['10', '11'], name: 'PSAT/NMSQT', category: 'College Readiness', startDate: '2025-10-01', endDate: '2025-10-31', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://satsuite.collegeboard.org/psat-nmsqt', definition: 'Preliminary SAT/National Merit Scholarship Qualifying Test: A practice test for the SAT that also serves as the entry point for the National Merit Scholarship Program for 11th graders (though often offered to 10th graders).' },
                { id: 'sat_essay', grade: ['11'], name: 'SAT with Essay', category: 'College Readiness', startDate: '2026-04-14', endDate: '2026-04-16', subject: 'Reading, Writing, Math, Essay', duration: 'Approx. 3 hours 50 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mme', definition: 'Scholastic Aptitude Test (SAT): A standardized test widely used for college admissions. Michigan provides this test free to all 11th graders as part of the Michigan Merit Examination (MME).' },
                { id: 'win_workplace', grade: ['11'], name: 'WIN Workplace Assessment', category: 'Career Readiness', subject: 'Career Readiness Skills', duration: 'Varies', startDate: '2026-04-13', endDate: '2026-05-22', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mme', definition: 'WIN Workplace Skills Assessment: Measures foundational workplace skills (e.g., Applied Math, Reading for Information). This assessment replaced ACT WorkKeys as part of the MME for 11th graders.' },
                { id: 'psat89_spring', grade: ['8'], name: 'PSAT 8/9 (Spring, Gr 8)', category: 'College Readiness', startDate: '2026-04-13', endDate: '2026-05-01', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mme', definition: 'Preliminary SAT (PSAT) 8/9: Part of the Michigan Merit Examination (MME) suite, administered in Spring to 8th graders to measure progress toward college readiness.' },
                { id: 'psat9_spring', grade: ['9'], name: 'PSAT 9 (Spring, Gr 9)', category: 'College Readiness', startDate: '2026-04-13', endDate: '2026-05-01', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mme', definition: 'PSAT 9: Part of the Michigan Merit Examination (MME) suite, administered in Spring to 9th graders to measure progress toward college readiness. (Note: This is the PSAT 9, not 8/9).' },
                { id: 'psat10_spring', grade: ['10'], name: 'PSAT 10 (Spring)', category: 'College Readiness', startDate: '2026-04-13', endDate: '2026-05-01', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mme', definition: 'Preliminary SAT (PSAT) 10: Part of the Michigan Merit Examination (MME) suite, administered in Spring to 10th graders. It is identical in format to the PSAT/NMSQT.' },
                { id: 'ap_exams', grade: ['9','10','11','12'], name: 'AP Exams', category: 'College Readiness', startDate: '2026-05-04', endDate: '2026-05-15', subject: 'Varies', duration: 'Varies by exam', resourceLink: 'https://apstudents.collegeboard.org/exam-calendar', definition: 'Advanced Placement (AP) Exams: Subject-specific exams from the College Board that allow high school students to earn college credit or advanced placement at many universities.' },
                { id: 'act_sept', grade: ['11','12'], name: 'ACT (Sept 6, 2025)', category: 'College Readiness', startDate: '2025-09-06', endDate: '2025-09-06', subject: 'English, Math, Reading, Science', duration: 'Approx. 3 hours 30 mins', resourceLink: 'https://www.act.org/content/act/en/products-and-services/the-act/registration/test-dates.html', definition: 'American College Testing (ACT): A standardized test used for college admissions. These are optional, national test dates that students register for individually. (Not to be confused with the state-funded SAT).' },
                { id: 'act_oct', grade: ['11','12'], name: 'ACT (Oct 25, 2025)', category: 'College Readiness', startDate: '2025-10-25', endDate: '2025-10-25', subject: 'English, Math, Reading, Science', duration: 'Approx. 3 hours 30 mins', resourceLink: 'https://www.act.org/content/act/en/products-and-services/the-act/registration/test-dates.html', definition: 'American College Testing (ACT): A standardized test used for college admissions. These are optional, national test dates that students register for individually. (Not to be confused with the state-funded SAT).' },
                { id: 'act_dec', grade: ['11','12'], name: 'ACT (Dec 13, 2025)', category: 'College Readiness', startDate: '2025-12-13', endDate: '2025-12-13', subject: 'English, Math, Reading, Science', duration: 'Approx. 3 hours 30 mins', resourceLink: 'https://www.act.org/content/act/en/products-and-services/the-act/registration/test-dates.html', definition: 'American College Testing (ACT): A standardized test used for college admissions. These are optional, national test dates that students register for individually. (Not to be confused with the state-funded SAT).' },
                { id: 'act_feb', grade: ['11','12'], name: 'ACT (Feb 7, 2026)', category: 'College Readiness', startDate: '2026-02-07', endDate: '2026-02-07', subject: 'English, Math, Reading, Science', duration: 'Approx. 3 hours 30 mins', resourceLink: 'https://www.act.org/content/act/en/products-and-services/the-act/registration/test-dates.html', definition: 'American College Testing (ACT): A standardized test used for college admissions. These are optional, national test dates that students register for individually. (Not to be confused with the state-funded SAT).' },
                { id: 'act_apr', grade: ['11','12'], name: 'ACT (Apr 18, 2026)', category: 'College Readiness', startDate: '2026-04-18', endDate: '2026-04-18', subject: 'English, Math, Reading, Science', duration: 'Approx. 3 hours 30 mins', resourceLink: 'https://www.act.org/content/act/en/products-and-services/the-act/registration/test-dates.html', definition: 'American College Testing (ACT): A standardized test used for college admissions. These are optional, national test dates that students register for individually. (Not to be confused with the state-funded SAT).' },
                { id: 'act_jun', grade: ['11','12'], name: 'ACT (Jun 13, 2026)', category: 'College Readiness', startDate: '2026-06-13', endDate: '2026-06-13', subject: 'English, Math, Reading, Science', duration: 'Approx. 3 hours 30 mins', resourceLink: 'https://www.act.org/content/act/en/products-and-services/the-act/registration/test-dates.html', definition: 'American College Testing (ACT): A standardized test used for college admissions. These are optional, national test dates that students register for individually. (Not to be confused with the state-funded SAT).' },
            ],
            "Universal Screeners & Benchmarks": [
                 { id: 'elm_fall', grade: ['K'], name: 'Early Literacy & Math (Fall)', category: 'Benchmark', startDate: '2025-08-25', endDate: '2025-10-17', subject: 'Reading, Math', duration: 'Untimed, approx. 20-30 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/pre-k-2-assessment', definition: 'Early Literacy & Mathematics Benchmark (KEO): A required assessment for Kindergarten students in the fall, used to identify potential learning needs.' },
                 { id: 'elm_spring', grade: ['K'], name: 'Early Literacy & Math (Spring)', category: 'Benchmark', startDate: '2026-04-13', endDate: '2026-05-29', subject: 'Reading, Math', duration: 'Untimed, approx. 20-30 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/pre-k-2-assessment', definition: 'Early Literacy & Mathematics Benchmark (KEO): A required assessment for Kindergarten students in the spring, used to measure end-of-year status.' },
                 { id: 'nwea_fall', grade: ['K','1','2','3','4','5','6','7','8','9','10','11'], name: 'NWEA MAP Growth (Fall)', category: 'Benchmark', startDate: '2025-09-02', endDate: '2025-09-26', subject: 'Reading, Math, Science', duration: 'Untimed, approx. 45-60 mins per subject', resourceLink: 'https://www.nwea.org/the-map-suite/family-toolkit/', definition: 'NWEA MAP Growth: A popular adaptive benchmark assessment used by many districts (typically 3 times a year) to measure student growth and inform instruction. One of four state-approved benchmark providers.' },
                 { id: 'nwea_winter', grade: ['K','1','2','3','4','5','6','7','8','9','10','11'], name: 'NWEA MAP Growth (Winter)', category: 'Benchmark', startDate: '2026-01-05', endDate: '2026-01-30', subject: 'Reading, Math, Science', duration: 'Untimed, approx. 45-60 mins per subject', resourceLink: 'https://www.nwea.org/the-map-suite/family-toolkit/', definition: 'NWEA MAP Growth: A popular adaptive benchmark assessment used by many districts (typically 3 times a year) to measure student growth and inform instruction. One of four state-approved benchmark providers.' },
                 { id: 'nwea_spring', grade: ['K','1','2','3','4','5','6','7','8'], name: 'NWEA MAP Growth (Spring)', category: 'Benchmark', startDate: '2026-05-04', endDate: '2026-05-29', subject: 'Reading, Math, Science', duration: 'Untimed, approx. 45-60 mins per subject', resourceLink: 'https://www.nwea.org/the-map-suite/family-toolkit/', definition: 'NWEA MAP Growth: A popular adaptive benchmark assessment used by many districts (typically 3 times a year) to measure student growth and inform instruction. One of four state-approved benchmark providers.' },
                 { id: 'dibels', grade: ['K','1','2','3'], name: 'DIBELS', category: 'Benchmark', subject: 'Early Literacy', duration: 'Approx. 5-10 mins', startDate: '', endDate: '', definition: 'Dynamic Indicators of Basic Early Literacy Skills (DIBELS): A series of short (1-minute) fluency measures used to monitor the development of early literacy and reading skills.'},
                 { id: 'fastbridge', grade: ['K','1','2','3','4','5','6','7','8','9','10','11','12'], name: 'FastBridge', category: 'Benchmark', subject: 'Reading, Math, Behavior', duration: 'Varies by module', startDate: '', endDate: '', definition: 'FastBridge: An assessment system for universal screening, progress monitoring, and diagnostics in reading, math, and behavior. One of four state-approved benchmark providers.'},
                 { id: 'iready', grade: ['K','1','2','3','4','5','6','7','8'], name: 'i-Ready Diagnostic', category: 'Benchmark', subject: 'Reading, Math', duration: 'Approx. 45-60 mins per subject', startDate: '', endDate: '', definition: 'i-Ready Diagnostic: An adaptive benchmark assessment for reading and math that provides a detailed profile of student strengths and weaknesses. One of four state-approved benchmark providers.'},
                 { id: 'star', grade: ['K','1','2','3','4','5','6','7','8','9','10','11','12'], name: 'STAR Reading/Math', category: 'Benchmark', subject: 'Reading, Math', duration: 'Approx. 20-30 mins', startDate: '', endDate: '', definition: 'STAR Assessments (Renaissance): Adaptive benchmark assessments for reading and math used for screening and progress monitoring.'},
                 { id: 'aimsweb', grade: ['K','1','2','3','4','5','6','7','8','9','10','11','12'], name: 'AIMSwebPlus', category: 'Benchmark', subject: 'Reading, Math', duration: 'Varies by measure', startDate: '', endDate: '', definition: 'AIMSwebPlus: A benchmark and progress monitoring system for reading and math, often using brief, fluency-based measures.'},
                 { id: 'smarter_balanced', grade: ['3','4','5','6','7','8'], name: 'Smarter Balanced Interim Assessments', category: 'Benchmark', subject: 'ELA, Math', duration: 'Varies', startDate: '', endDate: '', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/interim-assessments', definition: 'Smarter Balanced (SBAC) Interim Assessments: Optional, non-public assessments that provide teachers with actionable data on student progress toward M-STEP proficiency. One of four state-approved benchmark providers.'},
            ],
            "English Language Proficiency": [
                 { id: 'wida_screener', grade: ['K','1','2','3','4','5','6','7','8','9','10','11','12'], name: 'WIDA Screener', category: 'English Learner', startDate: '2025-08-25', endDate: '2026-05-22', subject: 'English Language Proficiency', duration: 'Varies by grade level', resourceLink: 'https://wida.wisc.edu/assess/screener', definition: 'WIDA Screener: An English language proficiency screening tool given to new students who may be English learners to determine their eligibility for EL services.'},
                 { id: 'wida_access', grade: ['K','1','2','3','4','5','6','7','8','9','10','11','12'], name: 'WIDA Access', category: 'English Learner', startDate: '2026-02-09', endDate: '2026-03-27', subject: 'English Language Proficiency', duration: 'Varies by grade level', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/wida', definition: 'WIDA ACCESS for ELLs: A summative assessment given annually to students identified as English Learners to measure their progress in learning English.'},
                 { id: 'wida_alt_access', grade: ['1','2','3','4','5','6','7','8','9','10','11','12'], name: 'WIDA Alternate Access', category: 'English Learner', startDate: '2026-02-09', endDate: '2026-03-27', subject: 'English Language Proficiency', duration: 'Varies', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/wida', definition: 'WIDA Alternate ACCESS: An assessment for English learners with the most significant cognitive disabilities, serving as an alternate to the WIDA ACCESS.'},
            ],
            "Alternate Assessments": [
                { id: 'mi_access_fi', grade: ['3','4','5','6','7','8','11'], name: 'MI-Access Functional Independence (FI)', category: 'Alternate', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'ELA, Math, Science, SS', duration: 'Untimed', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mi-access', definition: 'MI-Access (Functional Independence): Michigan\'s alternate assessment for students with significant cognitive impairments whose IEP teams have determined M-STEP is not appropriate. Measures essential life skills.' },
                { id: 'mi_access_si', grade: ['3','4','5','6','7','8','11'], name: 'MI-Access Supported Independence (SI)', category: 'Alternate', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'ELA, Math, Science, SS', duration: 'Untimed', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mi-access', definition: 'MI-Access (Supported Independence): Michigan\'s alternate assessment for students with significant cognitive impairments. SI bridges the gap between Functional Independence and M-STEP.' },
                { id: 'mi_access_p', grade: ['3','4','5','6','7','8','11'], name: 'MI-Access Participation (P)', category: 'Alternate', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'ELA, Math, Science, SS', duration: 'Untimed', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/mi-access', definition: 'MI-Access (Participation): Michigan\'s alternate assessment for students with the most significant cognitive impairments. Measures progress on extended content standards through observation.' },
            ]
        };

        const grades = ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
        
        const allHolidays = [
            { id: 'baha_i', religion: "Bahá'í", name: 'Birth of Bahá\'u\'lláh', startDate: '2025-10-26', endDate: '2025-10-27', definition: 'Celebrates the birthday of Bahá\'u\'lláh, the founder of the Bahá\'í Faith.'},
            { id: 'buddhism', religion: 'Buddhism', name: 'Bodhi Day', startDate: '2026-01-27', endDate: '2026-01-27', definition: 'Commemorates the day that Siddhartha Gautama attained enlightenment, becoming the Buddha.'},
            { id: 'christianity_c', religion: 'Christianity', name: 'Christmas', startDate: '2025-12-25', endDate: '2025-12-25', definition: 'Christian holiday celebrating the birth of Jesus Christ.'},
            { id: 'christianity_e', religion: 'Christianity', name: 'Easter', startDate: '2026-04-05', endDate: '2026-04-05', definition: 'Christian holiday celebrating the resurrection of Jesus Christ. (Note: Date is for Western Christianity).'},
            { id: 'christianity_gf', religion: 'Christianity', name: 'Good Friday', startDate: '2026-04-03', endDate: '2026-04-03', definition: 'Christian holiday commemorating the crucifixion of Jesus Christ.'},
            { id: 'hinduism_d', religion: 'Hinduism', name: 'Diwali', startDate: '2025-10-21', endDate: '2025-10-25', definition: 'The Hindu festival of lights, which celebrates the victory of light over darkness and good over evil.'},
            { id: 'islam_erf', religion: 'Islam', name: 'Eid al-Fitr', startDate: '2026-03-21', endDate: '2026-03-22', definition: '"Festival of Breaking the Fast," marks the end of Ramadan, the Muslim holy month of fasting.'},
            { id: 'islam_era', religion: 'Islam', name: 'Eid al-Adha', startDate: '2026-05-28', endDate: '2026-05-29', definition: '"Festival of the Sacrifice," honors the willingness of Ibrahim (Abraham) to sacrifice his son as an act of obedience to God.'},
            { id: 'jainism_p', religion: 'Jainism', name: 'Paryushana', startDate: '2025-08-23', endDate: '2025-08-30', definition: 'An 8-day festival of fasting, repentance, and meditation for Jains.'},
            { id: 'judaism_rh', religion: 'Judaism', name: 'Rosh Hashanah', startDate: '2025-09-23', endDate: '2025-09-24', definition: 'The Jewish New Year, a time of prayer and self-reflection. (Starts at sundown on Sept 22).'},
            { id: 'judaism_yk', religion: 'Judaism', name: 'Yom Kippur', startDate: '2025-10-02', endDate: '2025-10-02', definition: 'The Day of Atonement, the holiest day in Judaism, marked by fasting and prayer. (Starts at sundown on Oct 1).'},
            { id: 'judaism_p', religion: 'Judaism', name: 'Passover', startDate: '2026-04-02', endDate: '2026-04-09', definition: 'Commemorates the liberation of the Israelites from slavery in ancient Egypt. (Starts at sundown on Apr 1).'},
            { id: 'sikhism_v', religion: 'Sikhism', name: 'Vaisakhi', startDate: '2026-04-14', endDate: '2026-04-14', definition: 'Sikh New Year and the anniversary of the founding of the Khalsa (the Sikh community).'},
            { id: 'sikhism_gg', religion: 'Sikhism', name: 'Birthday of Guru Nanak', startDate: '2025-11-15', endDate: '2025-11-15', definition: 'Celebrates the birth of the first Sikh Guru, Guru Nanak.'}
        ];
        
        // Define category-level definitions
        const categoryDefinitions = {
            "State Mandated": "Assessments required by the state of Michigan, such as M-STEP and components of the Michigan Merit Examination (MME).",
            "College Readiness": "Assessments designed to measure a student's preparedness for post-secondary education or the workforce, such as the SAT, PSAT, and AP Exams.",
            "Career Readiness": "Assessments related to workforce readiness and foundational career skills, such as the WIN Workplace Assessment.",
            "Benchmark": "Assessments (often given 3x/year) used to check all students' progress, identify those at risk, and inform instruction. Michigan requires districts to use one of four approved providers.",
            "English Learner": "Assessments specifically for students identified as English Learners (ELs) to measure their progress in acquiring English (WIDA ACCESS) or to identify them for services (WIDA Screener).",
            "Alternate": "Assessments designed for students with the most significant cognitive disabilities for whom general assessments are not appropriate, as determined by an IEP team."
        };

        const otherAssessments = [];
        const districtEvents = [];
        
        // --- GLOBAL STATE ---
        // To store the data used to generate the current visualization
        let currentChartData = [];
        let currentViewStartDate;
        let currentViewEndDate;


        // --- DOM Elements ---
        const splashModal = document.getElementById('splash-modal');
        const setupModal = document.getElementById('setup-modal');
        const detailsModal = document.getElementById('details-modal');
        const exportModal = document.getElementById('export-modal');
        const mainContent = document.getElementById('main-content');
        
        const gradeFiltersContainer = document.getElementById('grade-filters');
        const assessmentFiltersContainer = document.getElementById('assessment-filters');
        
        const includeHolidays = document.getElementById('include-holidays');
        const holidayFiltersContainer = document.getElementById('holiday-filters-container');
        const holidayFilters = document.getElementById('holiday-filters');

        const includeLocalAssessments = document.getElementById('include-local-assessments');
        const localAssessmentsContainer = document.getElementById('local-assessments-container');
        const otherAssessmentName = document.getElementById('other-assessment-name');
        const otherAssessmentStart = document.getElementById('other-assessment-start');
        const otherAssessmentEnd = document.getElementById('other-assessment-end');
        const otherAssessmentsList = document.getElementById('other-assessments-list');
        
        const includeDistrictEvents = document.getElementById('include-district-events');
        const districtEventsContainer = document.getElementById('district-events-container');
        const districtEventName = document.getElementById('district-event-name');
        const districtEventStart = document.getElementById('district-event-start');
        const districtEventEnd = document.getElementById('district-event-end');
        const districtEventsList = document.getElementById('district-events-list');

        const viewSwitcher = document.getElementById('view-switcher');
        const ganttView = document.getElementById('gantt-view');
        const yearView = document.getElementById('year-view');
        const monthView = document.getElementById('month-view');
        const printContainer = document.getElementById('print-container');
        const calendarSubtitle = document.getElementById('calendar-subtitle');

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Parses a YYYY-MM-DD string into a Date object at UTC midnight.
         * This is crucial to avoid timezone offset issues.
         */
        function parseDateUTC(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            // Note: Months are 0-indexed in JS (0=Jan, 11=Dec)
            return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
        }

        /**
         * Formats a Date object to YYYY-MM-DD string.
         */
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        /**
         * Creates a DOM element with classes and text.
         */
        function createElement(tag, classNames = [], text = '') {
            const el = document.createElement(tag);
            el.classList.add(...classNames);
            if (text) {
                el.textContent = text;
            }
            return el;
        }

        // --- SETUP MODAL LOGIC ---

        function initSetupModal() {
            // 1. Populate Grades
            gradeFiltersContainer.innerHTML = '';
            grades.forEach(grade => {
                const label = createElement('label', ['flex', 'items-center', 'gap-2', 'p-2', 'rounded-lg', 'hover:bg-slate-100', 'cursor-pointer']);
                const checkbox = createElement('input', ['grade-filter', 'h-4', 'w-4', 'rounded', 'border-gray-300', 'text-[#0072b8]', 'focus:ring-[#0072b8]']);
                checkbox.type = 'checkbox';
                checkbox.value = grade;
                checkbox.addEventListener('change', updateAssessmentAvailability);
                label.appendChild(checkbox);
                label.appendChild(createElement('span', [], grade));
                gradeFiltersContainer.appendChild(label);
            });

            // 2. Populate Assessments
            assessmentFiltersContainer.innerHTML = '';
            for (const category in categorizedAssessments) {
                const categoryDiv = createElement('div', ['assessment-category-container']);
                const categoryHeader = createElement('h4', ['font-medium', 'mb-2', 'text-slate-500', 'border-b', 'pb-1'], category);
                categoryDiv.appendChild(categoryHeader);
                
                categorizedAssessments[category].forEach(assessment => {
                    const label = createElement('label', ['flex', 'items-center', 'gap-2', 'cursor-pointer', 'p-1', 'rounded', 'hover:bg-slate-50']);
                    const checkbox = createElement('input', ['assessment-filter', 'h-4', 'w-4', 'rounded', 'border-gray-300', 'text-[#0072b8]', 'focus:ring-[#0072b8]']);
                    checkbox.type = 'checkbox';
                    checkbox.id = `filter-${assessment.id}`;
                    checkbox.value = assessment.id;
                    checkbox.dataset.grades = JSON.stringify(assessment.grade);
                    
                    label.appendChild(checkbox);
                    label.appendChild(createElement('span', [], assessment.name));
                    
                    if(assessment.definition) {
                        const tooltip = createElement('span', ['tooltip-container'], 'ⓘ');
                        tooltip.appendChild(createElement('span', ['tooltip-text'], assessment.definition));
                        label.appendChild(tooltip);
                    }
                    
                    categoryDiv.appendChild(label);
                });
                assessmentFiltersContainer.appendChild(categoryDiv);
            }

            // 3. Populate Holidays
            holidayFilters.innerHTML = '';
            const religions = [...new Set(allHolidays.map(h => h.religion))].sort();
            religions.forEach(religion => {
                const label = createElement('label', ['flex', 'items-center', 'gap-2', 'p-1', 'rounded', 'hover:bg-slate-50', 'cursor-pointer']);
                const checkbox = createElement('input', ['holiday-filter', 'h-4', 'w-4', 'rounded', 'border-gray-300', 'text-[#0072b8]', 'focus:ring-[#0072b8]']);
                checkbox.type = 'checkbox';
                checkbox.value = religion;
                label.appendChild(checkbox);
                label.appendChild(createElement('span', ['text-sm'], religion));
                holidayFilters.appendChild(label);
            });
            
            // 4. Add Event Listeners for Toggles
            includeHolidays.addEventListener('change', () => {
                holidayFiltersContainer.classList.toggle('hidden', !includeHolidays.checked);
            });
            
            includeLocalAssessments.addEventListener('change', () => {
                localAssessmentsContainer.classList.toggle('hidden', !includeLocalAssessments.checked);
            });
            
            includeDistrictEvents.addEventListener('change', () => {
                districtEventsContainer.classList.toggle('hidden', !includeDistrictEvents.checked);
            });

            // 5. Add Event Listeners for "Add" buttons
            document.getElementById('add-other-btn').addEventListener('click', addOtherAssessment);
            document.getElementById('add-district-event-btn').addEventListener('click', addDistrictEvent);
        }

        // Dynamic Assessment availability
        function updateAssessmentAvailability() {
            const selectedGrades = new Set(
                Array.from(document.querySelectorAll('.grade-filter:checked')).map(cb => cb.value)
            );
            
            // Loop over each category
            document.querySelectorAll('.assessment-category-container').forEach(categoryDiv => {
                let visibleAssessmentsInCategory = 0;
                
                // Loop over each assessment checkbox within the category
                categoryDiv.querySelectorAll('label').forEach(label => {
                    const cb = label.querySelector('.assessment-filter');
                    if (!cb) return; // Skip category header

                    // If no grades are selected, show everything
                    if (selectedGrades.size === 0) {
                        label.classList.remove('hidden');
                        visibleAssessmentsInCategory++;
                        return; 
                    }
                    
                    // If grades ARE selected, filter by relevance.
                    const assessmentGrades = JSON.parse(cb.dataset.grades);
                    const isRelevant = assessmentGrades.some(g => selectedGrades.has(g));
                    
                    label.classList.toggle('hidden', !isRelevant);
                    
                    if (isRelevant) {
                        visibleAssessmentsInCategory++;
                    } else {
                        cb.checked = false; // Uncheck if it becomes irrelevant
                    }
                });
                
                // Hide the category header if no assessments within it are visible
                categoryDiv.classList.toggle('hidden', visibleAssessmentsInCategory === 0);
            });
        }
        
        // Add Local Assessment
        function addOtherAssessment() {
            const name = otherAssessmentName.value.trim();
            const start = otherAssessmentStart.value;
            const end = otherAssessmentEnd.value || start; // Default end date to start date if empty

            if (name && start) {
                const newAssessment = {
                    id: `other_${Date.now()}`,
                    name: name,
                    category: 'Local / Custom',
                    startDate: start,
                    endDate: end,
                    // Add other properties as needed
                    subject: 'N/A',
                    duration: 'N/A',
                    definition: 'A locally-defined custom assessment.'
                };
                otherAssessments.push(newAssessment);
                renderOtherAssessmentsList();
                // Clear inputs
                otherAssessmentName.value = '';
                otherAssessmentStart.value = '';
                otherAssessmentEnd.value = '';
            }
        }
        
        function renderOtherAssessmentsList() {
            otherAssessmentsList.innerHTML = '';
            if (otherAssessments.length === 0) {
                 otherAssessmentsList.innerHTML = '<p class="text-slate-400 italic">No custom assessments added.</p>';
                 return;
            }
            otherAssessments.forEach((item, index) => {
                const div = createElement('div', ['flex', 'justify-between', 'items-center', 'p-2', 'bg-slate-100', 'rounded']);
                div.textContent = `${item.name} (${item.startDate} to ${item.endDate})`;
                const removeBtn = createElement('button', ['text-red-500', 'hover:text-red-700', 'font-bold'], 'Remove');
                removeBtn.onclick = () => {
                    otherAssessments.splice(index, 1);
                    renderOtherAssessmentsList();
                };
                div.appendChild(removeBtn);
                otherAssessmentsList.appendChild(div);
            });
        }
        
        // Add District Event
        function addDistrictEvent() {
            const name = districtEventName.value.trim();
            const start = districtEventStart.value;
            const end = districtEventEnd.value || start;

            if (name && start) {
                const newEvent = {
                    id: `district_${Date.now()}`,
                    name: name,
                    category: 'District Event',
                    startDate: start,
                    endDate: end,
                    definition: `District Event: ${name}`
                };
                districtEvents.push(newEvent);
                renderDistrictEventsList();
                // Clear inputs
                districtEventName.value = '';
                districtEventStart.value = '';
                districtEventEnd.value = '';
            }
        }

        function renderDistrictEventsList() {
            districtEventsList.innerHTML = '';
             if (districtEvents.length === 0) {
                 districtEventsList.innerHTML = '<p class="text-slate-400 italic">No district events added.</p>';
                 return;
            }
            districtEvents.forEach((item, index) => {
                const div = createElement('div', ['flex', 'justify-between', 'items-center', 'p-2', 'bg-slate-100', 'rounded']);
                div.textContent = `${item.name} (${item.startDate} to ${item.endDate})`;
                const removeBtn = createElement('button', ['text-red-500', 'hover:text-red-700', 'font-bold'], 'Remove');
                removeBtn.onclick = () => {
                    districtEvents.splice(index, 1);
                    renderDistrictEventsList();
                };
                div.appendChild(removeBtn);
                districtEventsList.appendChild(div);
            });
        }

        // --- DATA COLLECTION & VISUALIZATION ---

        function collectData() {
            // 1. Get view range
            currentViewStartDate = parseDateUTC(document.getElementById('view-range-start').value);
            currentViewEndDate = parseDateUTC(document.getElementById('view-range-end').value);
            
            // Set calendar subtitle
            calendarSubtitle.textContent = `${currentViewStartDate.getUTCFullYear()}-${currentViewEndDate.getUTCFullYear()} Academic Year`;

            // 2. Get selected grades
            const selectedGrades = new Set(
                Array.from(document.querySelectorAll('.grade-filter:checked')).map(cb => cb.value)
            );

            // 3. Get selected assessments
            const selectedAssessmentIds = new Set(
                Array.from(document.querySelectorAll('.assessment-filter:checked')).map(cb => cb.value)
            );

            let data = [];
            for (const category in categorizedAssessments) {
                const assessments = categorizedAssessments[category].filter(assessment => {
                    if (!selectedAssessmentIds.has(assessment.id)) return false;
                    
                    // If no grades are selected, include all selected assessments
                    if (selectedGrades.size === 0) return true;
                    
                    // Otherwise, check for grade match
                    return assessment.grade.some(g => selectedGrades.has(g));
                });
                data.push(...assessments);
            }
            
            // 4. Add local assessments if box is checked
            if (includeLocalAssessments.checked) {
                data.push(...otherAssessments);
            }
            
            // 5. Add district events if box is checked
            if (includeDistrictEvents.checked) {
                data.push(...districtEvents);
            }

            // 6. Get selected holidays
            if (includeHolidays.checked) {
                const selectedReligions = new Set(
                    Array.from(document.querySelectorAll('.holiday-filter:checked')).map(cb => cb.value)
                );
                
                const holidays = allHolidays.filter(holiday => selectedReligions.has(holiday.religion))
                                        .map(h => ({ ...h, category: 'Religious Holiday' }));
                data.push(...holidays);
            }

            // 7. Parse dates and filter by view range
            currentChartData = data
                .map(d => ({
                    ...d,
                    start: parseDateUTC(d.startDate),
                    end: parseDateUTC(d.endDate || d.startDate) // Ensure end date exists
                }))
                .filter(d => d.start && d.end) // Ensure dates are valid
                .filter(d => {
                    // Filter out events that end before the view starts or start after the view ends
                    return d.end >= currentViewStartDate && d.start <= currentViewEndDate;
                });
                
            // 8. Sort data: by category, then start date
            currentChartData.sort((a, b) => {
                if (a.category < b.category) return -1;
                if (a.category > b.category) return 1;
                if (a.start < b.start) return -1;
                if (a.start > b.start) return 1;
                return 0;
            });
            
            return currentChartData;
        }

        function generateCalendar() {
            collectData();
            
            if (currentChartData.length === 0) {
                 document.getElementById('visualization-warnings').innerHTML = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                      <p class="font-bold">No Data</p>
                      <p>No assessments, holidays, or events match your selected criteria. Please adjust your selections in the "Re-configure" menu.</p>
                    </div>`;
            } else {
                 document.getElementById('visualization-warnings').innerHTML = '';
            }

            // Show/Hide Modals and Main Content
            setupModal.classList.add('hidden', 'opacity-0');
            mainContent.classList.remove('hidden');
            
            // Render the currently selected view
            switchView(viewSwitcher.value, true);
        }
        
        function switchView(view, isInitialLoad = false) {
             // Hide all views
            ganttView.classList.add('hidden');
            yearView.classList.add('hidden');
            monthView.classList.add('hidden');
            ganttView.innerHTML = ''; // Clear views to force redraw
            yearView.innerHTML = '';
            monthView.innerHTML = '';
            printContainer.innerHTML = ''; // Clear print container

            if (view === 'gantt') {
                ganttView.classList.remove('hidden');
                drawGanttChart();
            } else if (view === 'year') {
                yearView.classList.remove('hidden');
                drawYearAtAGlance();
            } else if (view === 'month') {
                monthView.classList.remove('hidden');
                drawMonthlyViews();
            }
            
            // Update export button state if needed (e.g., disable PNG for non-Gantt)
            // const exportPngBtn = document.getElementById('export-png-btn');
            // exportPngBtn.disabled = (view !== 'gantt');
            // const pngP = exportPngBtn.querySelector('p');
            // pngP.textContent = (view !== 'gantt') ? 'Download a PNG image (Only for Gantt Chart view)' : 'Download a PNG image (Gantt Chart view only).';
        }

        // --- GANTT CHART (d3.js) ---
        function drawGanttChart() {
            const data = currentChartData;
            ganttView.innerHTML = ''; // Clear previous chart
            
            const margin = { top: 30, right: 50, bottom: 50, left: 250 };
            const rowHeight = 30;
            const rowPadding = 10;
            const totalRowHeight = rowHeight + rowPadding;
            const height = (data.length * totalRowHeight) + margin.top + margin.bottom;
            
            // Use clientWidth for responsiveness
            const containerWidth = ganttView.clientWidth;
            const width = Math.max(containerWidth, 1200); // Minimum width
            
            const svg = d3.select("#gantt-view").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("style", "max-width: 100%; height: auto; font: 12px 'Inter', sans-serif;");

            const chart = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const innerWidth = width - margin.left - margin.right;
            
            // Clamp dates to the view range for visualization
            const clampedData = data.map(d => ({
                ...d,
                visStart: new Date(Math.max(d.start.getTime(), currentViewStartDate.getTime())),
                visEnd: new Date(Math.min(d.end.getTime(), currentViewEndDate.getTime()))
            }));

            // Time Scale (x-axis)
            const xScale = d3.scaleTime()
                .domain([currentViewStartDate, currentViewEndDate])
                .range([0, innerWidth]);

            // Y-axis (Task Names)
            const yScale = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([0, data.length * totalRowHeight])
                .padding(0.1);

            // X-Axis (Months)
            const xAxis = d3.axisTop(xScale)
                .ticks(d3.timeMonth.every(1))
                .tickFormat(d3.timeFormat("%b '%y"))
                .tickSize(height - margin.top - margin.bottom)
                .tickPadding(10);

            const xAxisGroup = chart.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`)
                .call(xAxis);
            
            xAxisGroup.selectAll(".tick line")
                .attr("stroke", "#e2e8f0"); // slate-200
            xAxisGroup.selectAll(".tick text")
                .attr("fill", "#64748b") // slate-500
                .attr("y", -10); // Position above the top line
            xAxisGroup.select(".domain").remove(); // Remove the main axis line

            // Y-Axis (Labels)
            const yAxis = d3.axisLeft(yScale)
                .tickSize(0)
                .tickPadding(10);

            const yAxisGroup = chart.append("g")
                .attr("class", "y-axis")
                .call(yAxis);
                
            yAxisGroup.select(".domain").remove();
            yAxisGroup.selectAll(".tick text")
                .attr("fill", "#334155") // slate-700
                .style("font-weight", "500")
                .call(wrapText, margin.left - 10); // Wrap text function

            // Create groups for each bar
            const groups = chart.selectAll("g.bar-group")
                .data(clampedData)
                .enter().append("g")
                .attr("class", "bar-group")
                .attr("transform", d => `translate(0, ${yScale(d.name)})`)
                .style("cursor", "pointer")
                .on("click", (event, d) => showDetailsModal(d));

            // Add the bars
            groups.append("rect")
                .attr("x", d => xScale(d.visStart))
                .attr("y", (rowPadding / 2))
                .attr("width", d => Math.max(1, xScale(d.visEnd) - xScale(d.visStart))) // Min width 1px
                .attr("height", rowHeight)
                .attr("fill", d => categoryColors[d.category] || "#94a3b8")
                .attr("rx", 6)
                .attr("ry", 6)
                .style("opacity", 0.85)
                .transition().duration(500)
                .attr("width", d => Math.max(1, xScale(d.visEnd) - xScale(d.visStart)));

            // Add text labels on bars
            groups.append("text")
                .attr("x", d => xScale(d.visStart) + 5)
                .attr("y", (totalRowHeight / 2) + 1) // Centered
                .attr("dy", "0.35em")
                .attr("fill", "white")
                .style("font-size", "11px")
                .style("font-weight", "500")
                .text(d => {
                    const barWidth = Math.max(1, xScale(d.visEnd) - xScale(d.visStart));
                    // Simple check to see if text fits
                    return (barWidth > (d.name.length * 6)) ? d.name : '';
                });
        }
        
        // --- YEAR-AT-A-GLANCE ---
        function drawYearAtAGlance() {
            yearView.innerHTML = ''; // Clear
            const gridContainer = createElement('div', ['year-view-grid']);
            gridContainer.id = 'year-view-grid';
            
            const legendContainer = createElement('div', ['mt-8', 'p-6', 'bg-white', 'rounded-lg', 'shadow']);
            legendContainer.innerHTML = '<h3 class="font-semibold text-lg text-slate-700 mb-4">Legend</h3>';
            const legendGrid = createElement('div', ['grid', 'grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-3']);
            legendGrid.id = 'year-view-legend';
            legendContainer.appendChild(legendGrid);

            yearView.appendChild(gridContainer);
            yearView.appendChild(legendContainer);
            
            const legendItems = new Map();

            const startMonth = currentViewStartDate.getUTCMonth();
            const startYear = currentViewStartDate.getUTCFullYear();
            const endMonth = currentViewEndDate.getUTCMonth();
            const endYear = currentViewEndDate.getUTCFullYear();

            let date = new Date(Date.UTC(startYear, startMonth, 1));
            const endDate = new Date(Date.UTC(endYear, endMonth, 1));

            while (date <= endDate) {
                const month = date.getUTCMonth();
                const year = date.getUTCFullYear();
                const monthContainer = createElement('div', ['year-month-container']);
                
                const monthHeader = createElement('h3', ['text-lg', 'font-semibold', 'text-slate-700', 'mb-2'],
                    date.toLocaleString('default', { month: 'long', year: 'numeric', timeZone: 'UTC' })
                );
                monthContainer.appendChild(monthHeader);

                const monthGrid = createElement('div', ['year-month-grid']);
                const daysOfWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                daysOfWeek.forEach(day => {
                    monthGrid.appendChild(createElement('div', ['year-day-header'], day));
                });
                
                const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay(); // 0=Sun, 1=Mon...
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                
                // Add empty cells for days before the 1st
                for (let i = 0; i < firstDayOfMonth; i++) {
                    monthGrid.appendChild(createElement('div', ['year-day-cell', 'other-month']));
                }

                // Add cells for each day
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = createElement('div', ['year-day-cell']);
                    cell.appendChild(createElement('span', ['day-num'], day));
                    
                    const currentDay = new Date(Date.UTC(year, month, day));
                    
                    // Find events for this day
                    const eventsToday = getEventsForDay(currentDay);
                    
                    if (eventsToday.length > 0) {
                        const dot = createElement('div', ['year-event-dot']);
                        // Use the color of the first event for the dot
                        const color = categoryColors[eventsToday[0].category] || '#94a3b8';
                        dot.style.backgroundColor = color;
                        cell.appendChild(dot);
                        
                        // Add events to legend
                        eventsToday.forEach(event => {
                            if (!legendItems.has(event.name)) {
                                legendItems.set(event.name, event.category);
                            }
                        });
                    }
                    
                    monthGrid.appendChild(cell);
                }
                
                monthContainer.appendChild(monthGrid);
                gridContainer.appendChild(monthContainer);
                
                date.setUTCMonth(date.getUTCMonth() + 1); // Move to next month
            }
            
            // Populate Legend
            const sortedLegend = new Map([...legendItems.entries()].sort());
            sortedLegend.forEach((category, name) => {
                const item = createElement('div', ['year-legend-item']);
                const dot = createElement('div', ['year-legend-dot']);
                dot.style.backgroundColor = categoryColors[category] || '#94a3b8';
                item.appendChild(dot);
                item.appendChild(createElement('span', [], name));
                legendGrid.appendChild(item);
            });
        }
        
        // --- MONTHLY VIEW ---
        function drawMonthlyViews() {
            monthView.innerHTML = ''; // Clear

            const startMonth = currentViewStartDate.getUTCMonth();
            const startYear = currentViewStartDate.getUTCFullYear();
            const endMonth = currentViewEndDate.getUTCMonth();
            const endYear = currentViewEndDate.getUTCFullYear();

            let date = new Date(Date.UTC(startYear, startMonth, 1));
            const endDate = new Date(Date.UTC(endYear, endMonth, 1));

            while (date <= endDate) {
                const month = date.getUTCMonth();
                const year = date.getUTCFullYear();
                const monthContainer = createElement('div', ['month-view-container', 'bg-white', 'p-6', 'rounded-lg', 'shadow-lg']);
                
                const monthHeader = createElement('h2', ['text-2xl', 'font-bold', 'text-slate-800', 'mb-4', 'text-center'],
                    date.toLocaleString('default', { month: 'long', 'year': 'numeric', timeZone: 'UTC' })
                );
                monthContainer.appendChild(monthHeader);

                const monthGrid = createElement('div', ['calendar-grid']);
                const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                daysOfWeek.forEach(day => {
                    monthGrid.appendChild(createElement('div', ['calendar-day-header'], day));
                });
                
                const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay();
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                
                // Get days from previous month
                const prevMonthEndDate = new Date(Date.UTC(year, month, 0));
                const prevMonthDays = prevMonthEndDate.getUTCDate();
                const prevMonthStartDay = prevMonthDays - firstDayOfMonth + 1;

                // Add empty cells for days before the 1st
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const day = prevMonthStartDay + i;
                    const cell = createElement('div', ['calendar-day', 'other-month']);
                    cell.appendChild(createElement('span', ['calendar-day-num'], day));
                    monthGrid.appendChild(cell);
                }

                // Add cells for each day
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = createElement('div', ['calendar-day']);
                    cell.appendChild(createElement('span', ['calendar-day-num'], day));
                    
                    const currentDay = new Date(Date.UTC(year, month, day));
                    const eventsToday = getEventsForDay(currentDay);
                    
                    eventsToday.forEach(event => {
                        const eventEl = createElement('div', ['calendar-event'], event.name);
                        eventEl.style.backgroundColor = categoryColors[event.category] || '#94a3b8';
                        eventEl.onclick = () => showDetailsModal(event);
                        cell.appendChild(eventEl);
                    });
                    
                    monthGrid.appendChild(cell);
                }
                
                // Add cells for next month to fill the grid
                const totalCells = firstDayOfMonth + daysInMonth;
                const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
                for (let i = 1; i <= remainingCells; i++) {
                     const cell = createElement('div', ['calendar-day', 'other-month']);
                     cell.appendChild(createElement('span', ['calendar-day-num'], i));
                     monthGrid.appendChild(cell);
                }
                
                monthContainer.appendChild(monthGrid);
                monthView.appendChild(monthContainer);
                
                date.setUTCMonth(date.getUTCMonth() + 1); // Move to next month
            }
        }
        
        /**
         * Helper to get all events for a specific day (UTC)
         */
        function getEventsForDay(day) {
            const dayTime = day.getTime();
            return currentChartData.filter(event => {
                const startTime = event.start.getTime();
                const endTime = event.end.getTime();
                return dayTime >= startTime && dayTime <= endTime;
            });
        }
        
        // --- DETAILS MODAL ---
        function showDetailsModal(d) {
            const body = document.getElementById('details-modal-body');
            body.innerHTML = ''; // Clear previous content

            // Title
            const title = createElement('h3', ['text-xl', 'font-bold', 'mb-2'], d.name);
            body.appendChild(title);

            // Category
            const category = createElement('p', ['text-sm', 'font-medium', 'mb-4']);
            category.innerHTML = `<strong>Category:</strong> <span style="color: ${categoryColors[d.category] || '#FFF'}">${d.category}</span>`;
            body.appendChild(category);

            // Dates
            const dates = createElement('p', ['text-sm', 'mb-2']);
            const dateString = (d.startDate === d.endDate) ? d.startDate : `${d.startDate} to ${d.endDate}`;
            dates.innerHTML = `<strong>Dates:</strong> ${dateString}`;
            body.appendChild(dates);

            // Definition
            if (d.definition) {
                const definition = createElement('p', ['text-sm', 'mb-2']);
                definition.innerHTML = `<strong>About:</strong> ${d.definition}`;
                body.appendChild(definition);
            }
            
            // Subject & Duration
            if (d.subject) {
                const subject = createElement('p', ['text-sm', 'mb-2']);
                subject.innerHTML = `<strong>Subject:</strong> ${d.subject}`;
                body.appendChild(subject);
            }
            if (d.duration) {
                const duration = createElement('p', ['text-sm', 'mb-2']);
                duration.innerHTML = `<strong>Duration:</strong> ${d.duration}`;
                body.appendChild(duration);
            }

            // Resource Link
            if (d.resourceLink) {
                const link = createElement('p', ['text-sm', 'mt-4']);
                link.innerHTML = `<strong>More Info:</strong> <a href="${d.resourceLink}" target="_blank">Visit Resource Page</a>`;
                body.appendChild(link);
            }

            detailsModal.classList.remove('hidden');
        }
        
        // --- TEXT WRAPPING for D3 ---
        function wrapText(text, width) {
            text.each(function () {
                let text = d3.select(this),
                    words = text.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = text.attr("y"),
                    dy = parseFloat(text.attr("dy") || 0),
                    tspan = text.text(null).append("tspan").attr("x", -10).attr("y", y).attr("dy", dy + "em");
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = text.append("tspan").attr("x", -10).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                    }
                }
            });
        }


        // --- EXPORT & SAVE FUNCTIONS ---
        
        function getSaveConfig() {
            const config = {
                viewRangeStart: document.getElementById('view-range-start').value,
                viewRangeEnd: document.getElementById('view-range-end').value,
                selectedGrades: Array.from(document.querySelectorAll('.grade-filter:checked')).map(cb => cb.value),
                selectedAssessments: Array.from(document.querySelectorAll('.assessment-filter:checked')).map(cb => cb.value),
                includeHolidays: includeHolidays.checked,
                selectedReligions: Array.from(document.querySelectorAll('.holiday-filter:checked')).map(cb => cb.value),
                includeLocal: includeLocalAssessments.checked,
                localAssessments: otherAssessments,
                includeDistrict: includeDistrictEvents.checked,
                districtEvents: districtEvents
            };
            return config;
        }

        // 1. Save PNG
        document.getElementById('export-png-btn').addEventListener('click', () => {
            const currentView = viewSwitcher.value;
            if (currentView !== 'gantt') {
                // We show a warning but still allow the click, as requested.
                console.warn("PNG export is only available for the Gantt Chart view.");
                // Optionally, we could show a more user-facing message.
            }
            
            const svgElement = document.querySelector("#gantt-view svg");
            if (svgElement) {
                saveSvgAsPng.saveSvgAsPng(svgElement, "assessment_calendar.png", { 
                    backgroundColor: "#f8fafc" 
                }); 
            } else {
                console.error("Could not find SVG element to export.");
            }
            exportModal.classList.add('hidden');
        });

        // 2. Save PDF / Print
        document.getElementById('export-pdf-btn').addEventListener('click', () => {
            // Defer loading library until it's needed
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                console.error("jsPDF library is not loaded.");
                return;
            }

            const currentView = viewSwitcher.value;
            printContainer.innerHTML = ''; // Clear print container
            
            if (currentView === 'gantt') {
                // Original PDF export for Gantt
                const svgElement = document.querySelector("#gantt-view svg");
                if (!svgElement) return;

                const { width, height } = svgElement.getBBox();
                const orientation = width > height ? 'l' : 'p';
                
                const pdf = new jsPDF(orientation, 'px', [width, height]);
                pdf.svg(svgElement).then(() => {
                    pdf.save('assessment_calendar.pdf');
                });
                
            } else if (currentView === 'year') {
                // Prepare Year view for printing
                const header = createElement('div', ['year-view-print-header']);
                header.innerHTML = `<h1>District-Wide Assessment Calendar</h1><h2>${calendarSubtitle.textContent} (Year-at-a-Glance)</h2>`;
                
                const grid = document.getElementById('year-view-grid').cloneNode(true);
                const legend = document.getElementById('year-view-legend').cloneNode(true);
                
                const printContent = createElement('div', ['year-view-print-container']);
                printContent.appendChild(header);
                printContent.appendChild(grid);
                printContent.appendChild(createElement('h2', ['font-semibold', 'text-lg', 'mt-8', 'mb-4'], 'Legend'));
                printContent.appendChild(legend);
                
                printContainer.appendChild(printContent);
                document.getElementById('gantt-view').style.display = 'none';
                document.getElementById('year-view').style.display = 'none';
                document.getElementById('month-view').style.display = 'none';
                
                window.print();
                
                document.getElementById('gantt-view').style.display = (viewSwitcher.value === 'gantt') ? 'block' : 'none';
                document.getElementById('year-view').style.display = (viewSwitcher.value === 'year') ? 'block' : 'none';
                document.getElementById('month-view').style.display = (viewSwitcher.value === 'month') ? 'block' : 'none';

            } else if (currentView === 'month') {
                // Prepare Month views for printing
                const monthPages = document.querySelectorAll('.month-view-container');
                monthPages.forEach(monthPage => {
                    const page = createElement('div', ['month-view-print-page']);
                    page.appendChild(monthPage.cloneNode(true));
                    printContainer.appendChild(page);
                });
                
                document.getElementById('gantt-view').style.display = 'none';
                document.getElementById('year-view').style.display = 'none';
                document.getElementById('month-view').style.display = 'none';
                
                window.print();
                
                document.getElementById('gantt-view').style.display = (viewSwitcher.value === 'gantt') ? 'block' : 'none';
                document.getElementById('year-view').style.display = (viewSwitcher.value === 'year') ? 'block' : 'none';
                document.getElementById('month-view').style.display = (viewSwitcher.value === 'month') ? 'block' : 'none';
            }
            
            exportModal.classList.add('hidden');
        });

        // 3. Save Data (JSON)
        document.getElementById('export-data-btn').addEventListener('click', () => {
            const config = getSaveConfig();
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'assessment_config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            exportModal.classList.add('hidden');
        });
        
        // 4. Save iCal
        document.getElementById('export-ical-btn').addEventListener('click', () => {
            // Defer loading library until it's needed
            const { ics } = window;
            if (!ics) {
                console.error("ics.js library is not loaded.");
                return;
            }
            
            if (currentChartData.length === 0) {
                alert("No data to export. Please generate a calendar first.");
                return;
            }

            const cal = ics();
            
            currentChartData.forEach(event => {
                // ics.js expects [YYYY, MM, DD, HH, MM]
                // Note: ics.js months are 1-indexed
                const start = [
                    event.start.getUTCFullYear(),
                    event.start.getUTCMonth() + 1,
                    event.start.getUTCDate()
                ];
                
                // For all-day events, the end date should be *the day after* the last day.
                const endDate = new Date(event.end.getTime());
                endDate.setUTCDate(endDate.getUTCDate() + 1);
                
                const end = [
                    endDate.getUTCFullYear(),
                    endDate.getUTCMonth() + 1,
                    endDate.getUTCDate()
                ];
                
                const title = event.name;
                
                let description = `Category: ${event.category}\n`;
                if (event.definition) description += `About: ${event.definition}\n`;
                if (event.subject) description += `Subject: ${event.subject}\n`;
                if (event.duration) description += `Duration: ${event.duration}\n`;
                if (event.resourceLink) description += `More Info: ${event.resourceLink}\n`;

                cal.addEvent(title, description, 'Kent ISD', start, end);
            });

            cal.download('KentISD_Assessment_Calendar');
            exportModal.classList.add('hidden');
        });


        // --- EVENT LISTENERS ---

        // Splash Modal
        document.getElementById('splash-proceed-btn').addEventListener('click', () => {
            splashModal.classList.add('hidden', 'opacity-0');
            setupModal.classList.remove('hidden', 'opacity-0');
        });

        // Setup Modal
        document.getElementById('generate-calendar-btn').addEventListener('click', generateCalendar);
        
        // Upload Config
        document.getElementById('upload-data-btn').addEventListener('click', () => {
            document.getElementById('upload-data-input').click();
        });
        
        document.getElementById('upload-data-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Restore config
                    document.getElementById('view-range-start').value = config.viewRangeStart || '2025-08-01';
                    document.getElementById('view-range-end').value = config.viewRangeEnd || '2026-06-30';
                    
                    document.querySelectorAll('.grade-filter').forEach(cb => {
                        cb.checked = (config.selectedGrades || []).includes(cb.value);
                    });
                    
                    updateAssessmentAvailability(); // Update based on restored grades
                    
                    document.querySelectorAll('.assessment-filter').forEach(cb => {
                        cb.checked = (config.selectedAssessments || []).includes(cb.value);
                    });
                    
                    includeHolidays.checked = config.includeHolidays;
                    holidayFiltersContainer.classList.toggle('hidden', !config.includeHolidays);
                    document.querySelectorAll('.holiday-filter').forEach(cb => {
                        cb.checked = (config.selectedReligions || []).includes(cb.value);
                    });

                    includeLocalAssessments.checked = config.includeLocal;
                    localAssessmentsContainer.classList.toggle('hidden', !config.includeLocal);
                    otherAssessments.length = 0; // Clear array
                    otherAssessments.push(...(config.localAssessments || []));
                    renderOtherAssessmentsList();
                    
                    includeDistrictEvents.checked = config.includeDistrict;
                    districtEventsContainer.classList.toggle('hidden', !config.includeDistrict);
                    districtEvents.length = 0; // Clear array
                    districtEvents.push(...(config.districtEvents || []));
                    renderDistrictEventsList();

                } catch (err) {
                    console.error("Error parsing config file:", err);
                    alert("There was an error reading the configuration file. It may be corrupted.");
                }
            };
            reader.readAsText(file);
            // Reset file input so 'change' event fires even if same file is re-uploaded
            event.target.value = null; 
        });

        // Main Content Buttons
        document.getElementById('reconfigure-btn').addEventListener('click', () => {
            mainContent.classList.add('hidden');
            setupModal.classList.remove('hidden', 'opacity-0');
        });
        
        // View Switcher
        viewSwitcher.addEventListener('change', (e) => switchView(e.target.value));

        // Export Modal
        document.getElementById('export-btn').addEventListener('click', () => {
            exportModal.classList.remove('hidden');
        });
        document.getElementById('export-modal-close').addEventListener('click', () => {
            exportModal.classList.add('hidden');
        });
        
        // Details Modal
        document.getElementById('details-modal-close').addEventListener('click', () => {
            detailsModal.classList.add('hidden');
        });

        // --- INITIALIZATION ---
        initSetupModal();
        renderOtherAssessmentsList();
        renderDistrictEventsList();
        
    </script>
</body>
</html>