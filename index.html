<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>District-Wide Assessment Calendar & Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/save-svg-as-png/1.4.17/saveSvgAsPng.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .tooltip {
            position: absolute; text-align: left; padding: 10px 15px; font-size: 13px;
            background: rgba(30, 41, 59, 0.95); color: white; border-radius: 8px;
            pointer-events: none; opacity: 0; transition: opacity 0.2s; max-width: 300px; line-height: 1.6;
        }
        .tooltip a { color: #60a5fa; text-decoration: underline; }
        .tooltip strong { color: #f59e0b; font-weight: 600; }
        .gantt-chart-container { width: 100%; overflow-x: auto; background-color: #ffffff; padding: 1rem 0; border-radius: 1rem; }
        .export-btn, .action-btn {
            padding: 8px 16px; border: none; border-radius: 8px; color: white;
            font-weight: 500; cursor: pointer; transition: background-color 0.2s;
        }
        .export-btn:hover, .action-btn:hover { opacity: 0.9; }
        #setup-modal {
            background: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            height: 90vh;
            max-height: 800px;
        }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .date-input { border: 1px solid #cbd5e1; border-radius: 6px; padding: 4px 8px; }
        .hidden { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col modal-content">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold text-slate-700">Create Your Assessment Calendar</h2>
                <p class="text-slate-500">Select grades, assessments, and holidays to build your custom visualization.</p>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <!-- Step 1: Grades -->
                <div class="mb-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">1. Select Grade Levels</h3>
                    <div id="grade-filters" class="grid grid-cols-4 sm:grid-cols-7 gap-3 text-sm"></div>
                </div>
                <!-- Step 2: Assessments -->
                <div class="mb-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">2. Select District & State Assessments</h3>
                    <div id="assessment-filters" class="space-y-4"></div>
                </div>
                 <!-- Step 3: Local Assessments -->
                <div class="mb-8">
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">3. Add Local / Custom Assessments</h3>
                     <label class="flex items-center cursor-pointer mb-4">
                        <input type="checkbox" id="include-local-assessments" class="h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]">
                        <span class="ml-2">Include Local / Custom Assessments</span>
                    </label>
                    <div id="local-assessments-container" class="hidden">
                        <div class="flex flex-col md:flex-row gap-3 items-center">
                            <input type="text" id="other-assessment-name" placeholder="E.g., Unit 1 Math Test" class="date-input w-full md:w-1/2">
                            <input type="date" id="other-assessment-start" class="date-input w-full md:w-1/4">
                            <input type="date" id="other-assessment-end" class="date-input w-full md:w-1/4">
                            <button id="add-other-btn" class="action-btn bg-[#0072b8] whitespace-nowrap px-4 py-2 text-sm w-full md:w-auto">Add</button>
                        </div>
                        <div id="other-assessments-list" class="mt-3 text-sm text-slate-600 space-y-1"></div>
                    </div>
                </div>
                <!-- Step 4: Holidays -->
                <div>
                    <h3 class="font-semibold text-lg mb-3 text-slate-600">4. Configure Holidays</h3>
                    <label class="flex items-center cursor-pointer mb-4">
                        <input type="checkbox" id="include-holidays" class="h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]">
                        <span class="ml-2">Include Religious Holidays</span>
                    </label>
                    <div id="holiday-filters-container" class="hidden">
                        <h4 class="font-medium mb-2 text-slate-500">Select Religions to Display:</h4>
                        <div id="holiday-filters" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t rounded-b-2xl">
                <button id="generate-calendar-btn" class="action-btn bg-[#8cc63f] w-full text-lg py-3">Generate Calendar</button>
            </div>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="main-content" class="container mx-auto p-4 md:p-8 hidden">
        <header class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-4 border-b border-slate-200">
            <div class="flex items-center gap-4">
                <img src="https://kentisd-cdn.fxbrt.com/downloads/about_kent_isd/kentisd-final-logos_primary-logo-gradient-tag.png" alt="Kent ISD Logo" class="h-14 md:h-16">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-700">District-Wide Assessment Calendar</h1>
                    <p class="text-sm md:text-base text-slate-500">2025-2026 Academic Year</p>
                </div>
            </div>
            <div class="flex gap-3 mt-4 sm:mt-0">
                 <button id="reconfigure-btn" class="action-btn bg-slate-500">Re-configure</button>
                <button id="save-png-btn" class="export-btn bg-[#0072b8]">Save as PNG</button>
                <button id="save-pdf-btn" class="export-btn bg-[#8cc63f]">Save as PDF</button>
            </div>
        </header>
        <main>
            <div id="visualization" class="gantt-chart-container shadow-lg"></div>
        </main>
    </div>
    
    <div class="tooltip"></div>

    <script>
        const { jsPDF } = window.jspdf;

        const categorizedAssessments = {
            "State Mandated": [
                { id: 'mstep_ela_math', grade: '3-7', name: 'M-STEP (ELA, Math)', category: 'State Mandated', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'ELA, Math', duration: 'Varies, approx. 1-2.5 hours per subject', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/m-step' },
                { id: 'mstep_sci_ss', grade: '5, 8, 11', name: 'M-STEP (Science, SS)', category: 'State Mandated', startDate: '2026-04-13', endDate: '2026-05-22', subject: 'Science, Social Studies', duration: 'Varies, approx. 1-1.5 hours per subject', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/m-step' },
            ],
            "College Readiness & Career": [
                { id: 'psat89_fall', grade: '8', name: 'PSAT 8/9 (Fall)', category: 'College Readiness', startDate: '2025-10-01', endDate: '2025-10-31', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://satsuite.collegeboard.org/psat-8-9/preparing/parent-tutorial' },
                { id: 'psat_nmsqt', grade: '10', name: 'PSAT/NMSQT', category: 'College Readiness', startDate: '2025-10-01', endDate: '2025-10-31', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://satsuite.collegeboard.org/psat-nmsqt/preparing/parent-perspectives' },
                { id: 'sat_essay', grade: '11', name: 'SAT with Essay', category: 'College Readiness', startDate: '2026-04-14', endDate: '2026-04-16', subject: 'Reading, Writing, Math, Essay', duration: 'Approx. 3 hours 50 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/sat' },
                { id: 'act_workkeys', grade: '11', name: 'ACT WorkKeys', category: 'Career Readiness', startDate: '2026-04-14', endDate: '2026-04-16', subject: 'Applied Math, Graphic Literacy, Workplace Docs', duration: 'Approx. 3 hours', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/workkeys' },
                { id: 'win_workplace', grade: '11', name: 'WIN Workplace Assessment', category: 'Career Readiness', subject: 'Career Readiness Skills', duration: 'Varies' },
                { id: 'psat89_spring', grade: '8', name: 'PSAT 8/9 (Spring)', category: 'College Readiness', startDate: '2026-04-13', endDate: '2026-05-01', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://satsuite.collegeboard.org/psat-8-9' },
                { id: 'psat_spring', grade: '9-10', name: 'PSAT (Spring)', category: 'College Readiness', startDate: '2026-04-13', endDate: '2026-05-01', subject: 'Reading, Writing, Math', duration: 'Approx. 2 hours 45 mins', resourceLink: 'https://satsuite.collegeboard.org/psat-10' },
            ],
            "Universal Screeners & Benchmarks": [
                 { id: 'elm_fall', grade: 'K', name: 'Early Literacy & Math (Fall)', category: 'Benchmark', startDate: '2025-08-25', endDate: '2025-10-24', subject: 'Reading, Math', duration: 'Untimed, approx. 20-30 mins', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/pre-k-2-assessment' },
                { id: 'nwea_fall', grade: 'K-11', name: 'NWEA MAP Growth (Fall)', category: 'Benchmark', startDate: '2025-09-02', endDate: '2025-09-26', subject: 'Reading, Math, Science', duration: 'Untimed, approx. 45-60 mins per subject', resourceLink: 'https://www.nwea.org/the-map-suite/family-toolkit/' },
                { id: 'nwea_winter', grade: 'K-11', name: 'NWEA MAP Growth (Winter)', category: 'Benchmark', startDate: '2026-01-05', endDate: '2026-01-30', subject: 'Reading, Math, Science', duration: 'Untimed, approx. 45-60 mins per subject', resourceLink: 'https://www.nwea.org/the-map-suite/family-toolkit/' },
                { id: 'nwea_spring', grade: 'K-8', name: 'NWEA MAP Growth (Spring)', category: 'Benchmark', startDate: '2026-05-04', endDate: '2026-05-29', subject: 'Reading, Math, Science', duration: 'Untimed, approx. 45-60 mins per subject', resourceLink: 'https://www.nwea.org/the-map-suite/family-toolkit/' },
                { id: 'dibels', grade: 'K-3', name: 'DIBELS', category: 'Benchmark', subject: 'Early Literacy', duration: 'Approx. 5-10 mins'},
                { id: 'fastbridge', grade: 'K-12', name: 'FastBridge', category: 'Benchmark', subject: 'Reading, Math, Behavior', duration: 'Varies by module'},
                { id: 'iready', grade: 'K-8', name: 'i-Ready Diagnostic', category: 'Benchmark', subject: 'Reading, Math', duration: 'Approx. 45-60 mins per subject'},
                { id: 'star', grade: 'K-12', name: 'STAR Reading/Math', category: 'Benchmark', subject: 'Reading, Math', duration: 'Approx. 20-30 mins'},
                { id: 'aimsweb', grade: 'K-12', name: 'AIMSwebPlus', category: 'Benchmark', subject: 'Reading, Math', duration: 'Varies by measure'},
            ],
            "English Language Proficiency": [
                 { id: 'wida_screener', grade: 'K-12', name: 'WIDA Screener', category: 'English Learner', startDate: '2025-08-25', endDate: '2026-05-22', subject: 'English Language Proficiency', duration: 'Varies by grade level', resourceLink: 'https://wida.wisc.edu/assess/screener' },
                { id: 'wida_access', grade: 'K-12', name: 'WIDA ACCESS', category: 'English Learner', startDate: '2026-02-09', endDate: '2026-03-27', subject: 'English Language Proficiency', duration: 'Varies by grade level', resourceLink: 'https://www.michigan.gov/mde/services/student-assessment/wida' },
            ],
            "Alternate Assessments": [
                { id: 'mi_access', grade: '3-8, 11', name: 'MI-Access', category: 'Alternate Assessment', subject: 'ELA, Math, Science, SS', duration: 'Varies by student'},
            ]
        };
        const allAssessments = Object.values(categorizedAssessments).flat();

        const holidayData = [
            // Using arrays for religions now
            { name: 'Rosh Hashanah', religions: ['Jewish'], startDate: '2025-09-22', endDate: '2025-09-24' },
            { name: 'Yom Kippur', religions: ['Jewish'], startDate: '2025-10-01', endDate: '2025-10-02' },
            { name: 'Diwali', religions: ['Hindu', 'Sikh', 'Jain'], startDate: '2025-10-21', endDate: '2025-10-21' },
            { name: 'Christmas', religions: ['Christian'], startDate: '2025-12-25', endDate: '2025-12-25' },
            { name: 'Hanukkah', religions: ['Jewish'], startDate: '2025-12-14', endDate: '2025-12-22' },
            { name: 'Orthodox Christmas', religions: ['Orthodox Christian'], startDate: '2026-01-07', endDate: '2026-01-07' },
            { name: 'Lunar New Year', religions: ['East Asian'], startDate: '2026-02-17', endDate: '2026-02-17' },
            { name: 'Ramadan Begins', religions: ['Muslim'], startDate: '2026-02-18', endDate: '2026-02-18' },
            { name: 'Eid al-Fitr', religions: ['Muslim'], startDate: '2026-03-20', endDate: '2026-03-20' },
            { name: 'Good Friday', religions: ['Christian'], startDate: '2026-04-03', endDate: '2026-04-03' },
            { name: 'Passover', religions: ['Jewish'], startDate: '2026-04-01', endDate: '2026-04-09' },
            { name: 'Easter', religions: ['Christian'], startDate: '2026-04-05', endDate: '2026-04-05' },
            { name: 'Orthodox Easter', religions: ['Orthodox Christian'], startDate: '2026-04-12', endDate: '2026-04-12' },
            { name: 'Vaisakhi', religions: ['Sikh', 'Hindu'], startDate: '2026-04-13', endDate: '2026-04-13' },
        ];
        
        let otherAssessments = [];

        document.addEventListener('DOMContentLoaded', () => {
            populateModalFilters();
            setupEventListeners();
        });

        function populateModalFilters() {
            const gradeFilters = document.getElementById('grade-filters');
            const assessmentFilters = document.getElementById('assessment-filters');
            const holidayFilters = document.getElementById('holiday-filters');

            const grades = ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
            grades.forEach(g => {
                gradeFilters.innerHTML += `<label class="flex items-center cursor-pointer text-slate-700"><input type="checkbox" class="grade-filter h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]" value="${g}">
                <span class="ml-2">${g}</span></label>`;
            });

            for (const category in categorizedAssessments) {
                let categoryHtml = `<div class="mb-3"><h4 class="font-medium text-md text-slate-500 mb-2">${category}</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3">`;
                categorizedAssessments[category].forEach(a => {
                    const hasDate = a.startDate && a.endDate;
                    const dateInputs = hasDate ? '' : `
                        <div class="assessment-date-inputs hidden pl-6 mt-1 flex items-center gap-2">
                            <input type="date" id="start-${a.id}" class="date-input text-sm">
                            <span class="text-slate-400">-</span>
                            <input type="date" id="end-${a.id}" class="date-input text-sm">
                        </div>`;
                    categoryHtml += `
                        <div>
                            <label class="flex items-center cursor-pointer text-slate-700">
                                <input type="checkbox" class="assessment-filter h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]" value="${a.id}">
                                <span class="ml-2">${a.name} (Grades: ${a.grade})</span>
                            </label>
                            ${dateInputs}
                        </div>`;
                });
                categoryHtml += `</div></div>`;
                assessmentFilters.innerHTML += categoryHtml;
            }
            
            const holidayReligions = [...new Set(holidayData.flatMap(d => d.religions))];
            holidayReligions.forEach(r => {
                holidayFilters.innerHTML += `<label class="flex items-center cursor-pointer text-slate-700"><input type="checkbox" class="holiday-filter h-4 w-4 rounded border-gray-300 text-[#0072b8] focus:ring-[#0072b8]" value="${r}">
                <span class="ml-2">${r}</span></label>`;
            });
        }
        
        function setupEventListeners(){
            // Modal event listeners
            document.getElementById('include-local-assessments').addEventListener('change', (e) => {
                document.getElementById('local-assessments-container').classList.toggle('hidden', !e.target.checked);
            });

            document.getElementById('include-holidays').addEventListener('change', (e) => {
                document.getElementById('holiday-filters-container').classList.toggle('hidden', !e.target.checked);
            });

            document.getElementById('assessment-filters').addEventListener('change', (e) => {
                if (e.target.classList.contains('assessment-filter')) {
                    const dateInputs = e.target.closest('div').querySelector('.assessment-date-inputs');
                    if (dateInputs) {
                        dateInputs.classList.toggle('hidden', !e.target.checked);
                    }
                }
            });

            document.getElementById('add-other-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('other-assessment-name');
                const startInput = document.getElementById('other-assessment-start');
                const endInput = document.getElementById('other-assessment-end');
                if (nameInput.value && startInput.value && endInput.value) {
                    otherAssessments.push({
                        name: nameInput.value,
                        startDate: startInput.value,
                        endDate: endInput.value,
                        category: 'Local/Custom',
                        type: 'assessment',
                        grade: 'Custom'
                    });
                    nameInput.value = '';
                    startInput.value = '';
                    endInput.value = '';
                    renderOtherAssessmentsList();
                } else {
                    alert('Please provide a name, start date, and end date for the custom assessment.');
                }
            });

            document.getElementById('generate-calendar-btn').addEventListener('click', () => {
                updateVisualization();
                document.getElementById('setup-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            });
            
            // Main content event listeners
            document.getElementById('reconfigure-btn').addEventListener('click', () => {
                 document.getElementById('setup-modal').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
            });
            
            document.getElementById('save-png-btn').addEventListener('click', () => saveAsPng());
            document.getElementById('save-pdf-btn').addEventListener('click', () => saveAsPdf());
        }

        function renderOtherAssessmentsList() {
            const listEl = document.getElementById('other-assessments-list');
            listEl.innerHTML = otherAssessments.map(a => `<div class="bg-slate-100 p-2 rounded">✓ ${a.name} (${a.startDate} to ${a.endDate})</div>`).join('');
        }

        function parseGrade(gradeStr) {
            if (!gradeStr) return [];
            if (gradeStr.includes('-')) {
                const parts = gradeStr.split('-');
                const start = parts[0] === 'K' ? 0 : parseInt(parts[0]);
                const end = parseInt(parts[1]);
                let grades = [];
                for (let i = start; i <= end; i++) {
                    grades.push(i === 0 ? 'K' : i.toString());
                }
                return grades;
            }
            if (gradeStr.toLowerCase() === 'all' || gradeStr.toLowerCase() === 'k-12') {
                return ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
            }
            return gradeStr.split(',').map(s => s.trim());
        }

        function updateVisualization() {
            const selectedGrades = Array.from(document.querySelectorAll('.grade-filter:checked')).map(el => el.value);
            const selectedAssessmentIds = Array.from(document.querySelectorAll('.assessment-filter:checked')).map(el => el.value);
            
            let filteredAssessments = allAssessments.filter(a => selectedAssessmentIds.includes(a.id)).map(a => {
                if (!a.startDate) {
                    const startDate = document.getElementById(`start-${a.id}`).value;
                    const endDate = document.getElementById(`end-${a.id}`).value;
                    if (startDate && endDate) {
                        return {...a, startDate, endDate};
                    }
                    return null;
                }
                return a;
            }).filter(Boolean);

            let finalData = filteredAssessments.filter(d => {
                const itemGrades = parseGrade(d.grade);
                return selectedGrades.some(sg => itemGrades.includes(sg));
            }).map(d => ({...d, type: 'assessment'}));
            
            const includeLocal = document.getElementById('include-local-assessments').checked;
            if (includeLocal) {
                 finalData = [...finalData, ...otherAssessments];
            }

            const includeHolidays = document.getElementById('include-holidays').checked;
            if (includeHolidays) {
                const selectedReligions = Array.from(document.querySelectorAll('.holiday-filter:checked')).map(el => el.value);
                const filteredHolidays = holidayData
                    .filter(d => d.religions.some(r => selectedReligions.includes(r)))
                    .map(d => ({...d, name: d.name, type: 'holiday'}));
                finalData = [...finalData, ...filteredHolidays];
            }
            
            finalData.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            renderGanttChart(finalData);
        }
        
        function renderGanttChart(data) {
            const container = d3.select("#visualization");
            container.html("");

            if (data.length === 0) {
                container.append("div").attr("class", "text-center p-10 text-slate-500").text("No data to display. Click 'Re-configure' to change selections.");
                return;
            }

            const margin = { top: 50, right: 30, bottom: 40, left: 220 };
            const containerWidth = document.getElementById('visualization').clientWidth;
            const width = Math.max(containerWidth, 900) - margin.left - margin.right;
            const itemHeight = 30;
            const itemMargin = 10;
            const height = data.length * (itemHeight + itemMargin);
            
            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            const timeDomain = [new Date('2025-08-01'), new Date('2026-06-30')];
            const xScale = d3.scaleTime().domain(timeDomain).range([0, width]);

            svg.append("g").call(d3.axisTop(xScale).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%B"))).selectAll("text").style("font-size", "12px").style("color", "#475569");
            svg.append("g").attr("class", "grid-lines").selectAll("line").data(xScale.ticks(d3.timeMonth.every(1))).enter().append("line").attr("x1", d => xScale(d)).attr("x2", d => xScale(d)).attr("y1", 0).attr("y2", height).attr("stroke", "#e2e8f0").attr("stroke-width", 1);
            
            const tooltip = d3.select(".tooltip");
            
            const kentISDPalette = ['#0072b8', '#8cc63f', '#f58220', '#41b6e6', '#004b8d', '#a9a9a9', '#d45d00'];
            const categoryDomains = [...new Set(allAssessments.map(d => d.category)), 'Local/Custom'];
            const colorScale = d3.scaleOrdinal().domain(categoryDomains).range(kentISDPalette);

            svg.selectAll(".bar-group").data(data).enter().append("g")
                .attr("transform", (d, i) => `translate(0, ${i * (itemHeight + itemMargin)})`)
                .append("rect")
                .attr("x", d => xScale(new Date(d.startDate)))
                .attr("width", d => Math.max(2, xScale(new Date(d.endDate)) - xScale(new Date(d.startDate))))
                .attr("height", itemHeight).attr("rx", 5).attr("ry", 5)
                .style("fill", d => d.type === 'holiday' ? '#64748b' : colorScale(d.category))
                .style("opacity", 0.9)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("opacity", 1);
                    tooltip.transition().duration(200).style("opacity", 1);
                    let tooltipContent = `<strong>${d.name}</strong><br/>`;
                    if (d.grade && d.grade !== 'Custom') tooltipContent += `<strong>Grade(s):</strong> ${d.grade}<br/>`;
                    if (d.category) tooltipContent += `<strong>Category:</strong> ${d.category}<br/>`;
                    if (d.subject) tooltipContent += `<strong>Subject:</strong> ${d.subject}<br/>`;
                    if (d.duration) tooltipContent += `<strong>Duration:</strong> ${d.duration}<br/>`;
                    if (d.religions) tooltipContent += `<strong>Observed by:</strong> ${d.religions.join(', ')}<br/>`;
                    tooltipContent += `<strong>Window:</strong> ${new Date(d.startDate).toLocaleDateString()} - ${new Date(d.endDate).toLocaleDateString()}<br/>`;
                    if (d.resourceLink) tooltipContent += `<a href="${d.resourceLink}" target="_blank">MDE Parent Resources</a>`;
                    
                    tooltip.html(tooltipContent)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this).style("opacity", 0.9);
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            svg.selectAll(".item-label").data(data).enter().append("text")
                .attr("x", -15).attr("y", (d, i) => i * (itemHeight + itemMargin) + itemHeight / 2)
                .attr("dy", "0.35em").attr("text-anchor", "end").style("font-size", "12px")
                .style("fill", "#334155").text(d => d.name)
                .call(wrap, margin.left - 25);
        }
        
        function wrap(text, width) { text.each(function () { var text = d3.select(this), words = text.text().split(/\s+/).reverse(), word, line = [], lineNumber = 0, lineHeight = 1.1, x = text.attr("x"), y = text.attr("y"), dy = parseFloat(text.attr("dy")), tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em"); while (word = words.pop()) { line.push(word); tspan.text(line.join(" ")); if (tspan.node().getComputedTextLength() > width) { line.pop(); tspan.text(line.join(" ")); line = [word]; tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word); } } }); }
        function saveAsPng(){ const svgElement = document.querySelector("#visualization svg"); if(svgElement){ saveSvgAsPng(svgElement, "assessment-calendar.png", {backgroundColor: 'white', scale: 2}); } else { alert("No chart to save!"); } }
        function saveAsPdf(){ const svgElement = document.querySelector("#visualization svg"); if(!svgElement) { alert("No chart to save!"); return; } const { width, height } = svgElement.getBBox(); const pdf = new jsPDF(width > height ? 'l' : 'p', 'pt', [width, height]); svgAsPngUri(svgElement, {scale: 2}, function(uri) { pdf.addImage(uri, 'PNG', 0, 0, width, height); pdf.save('assessment-calendar.pdf'); }); }

    </script>
</body>
</html>
